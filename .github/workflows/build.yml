name: Build with Multi-Platform Icons

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            name: linux
            artifact_name: myapp-linux
            icon_file: "RS.png"  # 修改这里
          - os: macos-latest
            name: macos
            artifact_name: myapp-macos
            icon_file: "RS.icns"  # 修改这里
          - os: windows-latest
            name: windows
            artifact_name: myapp-windows
            icon_file: "RS.ico"  # 修改这里

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller

    - name: Verify icon files
      run: |
        echo "=== 检查图标文件 ==="
        ls -la || echo "当前目录文件列表"
        echo ""
        echo "=== 查找RS图标文件 ==="
        find . -name "RS.ico" -o -name "RS.icns" -o -name "RS.png" | grep -v ".git" || echo "未找到RS图标文件"
        echo ""
        echo "=== 检查根目录RS图标 ==="
        ls -la RS.ico RS.icns RS.png 2>/dev/null || echo "根目录无RS图标文件"

    - name: Build with platform-specific icons
      run: |
        echo "正在为 ${{ matrix.os }} 构建..."
        
        # 设置可执行文件名称
        APP_NAME="P.O.A职员各项指标登记"
        
        # 设置Python脚本路径（请修改为你的实际路径）
        SCRIPT_PATH="P.O.A职员各项指标登记.py"  # 修改这里！
        
        if [ "${{ matrix.os }}" == "windows-latest" ] && [ -f "RS.ico" ]; then
          echo "使用Windows图标构建..."
          pyinstaller --onefile --icon=RS.ico --name=$APP_NAME "$SCRIPT_PATH"
          
        elif [ "${{ matrix.os }}" == "macos-latest" ] && [ -f "RS.icns" ]; then
          echo "使用macOS图标构建..."
          pyinstaller --onefile --icon=RS.icns --name=$APP_NAME "$SCRIPT_PATH"
          
        elif [ "${{ matrix.os }}" == "ubuntu-latest" ] && [ -f "RS.png" ]; then
          echo "使用Linux图标构建..."
          pyinstaller --onefile --icon=RS.png --name=$APP_NAME "$SCRIPT_PATH"
          
        else
          echo "未找到平台专用图标，使用默认设置构建..."
          pyinstaller --onefile --name=$APP_NAME "$SCRIPT_PATH"
        fi

    - name: Verify build output
      run: |
        echo "=== 构建结果 ==="
        ls -la dist/
        echo ""
        if [ "${{ matrix.os }}" == "windows-latest" ]; then
          echo "Windows可执行文件大小:"
          ls -lh dist/myapp.exe
        else
          echo "可执行文件大小:"
          ls -lh dist/myapp
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: dist/
        retention-days: 30

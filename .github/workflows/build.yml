name: Build P.O.A职员各项指标登记

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            name: linux
            artifact_name: P.O.A职员各项指标登记-linux
            icon_file: "RS.png"
          - os: macos-latest
            name: macos
            artifact_name: P.O.A职员各项指标登记-macos
            icon_file: "RS.icns"
          - os: windows-latest
            name: windows
            artifact_name: P.O.A职员各项指标登记-windows
            icon_file: "RS.ico"

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller

    - name: Verify icon files
      shell: bash  # 关键修改：强制使用bash
      run: |
        echo "=== 检查图标文件 ==="
        ls -la || echo "当前目录文件列表"
        echo ""
        echo "=== 查找RS图标文件 ==="
        find . -name "RS.ico" -o -name "RS.icns" -o -name "RS.png" | grep -v ".git" || echo "未找到RS图标文件"
        echo ""
        echo "=== 检查根目录文件 ==="
        ls -la "P.O.A职员各项指标登记.py" RS.ico RS.icns RS.png 2>/dev/null || echo "部分文件不存在"

    - name: Build with platform-specific icons
      shell: bash  # 关键修改：强制使用bash
      run: |
        echo "正在为 ${{ matrix.os }} 构建..."
        
        # 设置可执行文件名称
        APP_NAME="P.O.A职员各项指标登记"
        
        # 设置Python脚本路径
        SCRIPT_PATH="P.O.A职员各项指标登记.py"
        
        if [ "${{ matrix.os }}" == "windows-latest" ] && [ -f "RS.ico" ]; then
          echo "使用Windows图标构建..."
          pyinstaller --onefile --icon=RS.ico --name="$APP_NAME" "$SCRIPT_PATH"
          
        elif [ "${{ matrix.os }}" == "macos-latest" ] && [ -f "RS.icns" ]; then
          echo "使用macOS图标构建..."
          pyinstaller --onefile --icon=RS.icns --name="$APP_NAME" "$SCRIPT_PATH"
          
        elif [ "${{ matrix.os }}" == "ubuntu-latest" ] && [ -f "RS.png" ]; then
          echo "使用Linux图标构建..."
          pyinstaller --onefile --icon=RS.png --name="$APP_NAME" "$SCRIPT_PATH"
          
        else
          echo "未找到平台专用图标，使用默认设置构建..."
          pyinstaller --onefile --name="$APP_NAME" "$SCRIPT_PATH"
        fi

    - name: Verify build output
      shell: bash  # 关键修改：强制使用bash
      run: |
        echo "=== 构建结果 ==="
        ls -la dist/
        echo ""
        if [ "${{ matrix.os }}" == "windows-latest" ]; then
          echo "Windows可执行文件:"
          ls -lh "dist/P.O.A职员各项指标登记.exe"
        else
          echo "可执行文件:"
          ls -lh "dist/P.O.A职员各项指标登记"
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: dist/
        retention-days: 30
